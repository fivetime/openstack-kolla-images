FROM {{ namespace }}/{{ image_prefix }}nexus:{{ tag }}

{% block labels %}
    LABEL maintainer="{{ maintainer }}" name="{{ image_name }}" build-date="{{ build_date }}"
{% endblock %}

{% block nexus_proxy_header %}{% endblock %}

{% import "macros.j2" as macros with context %}

# 只安装 proxy 特有的包
{% if base_package_type == 'rpm' %}
    {% set nexus_proxy_packages = [
        'nginx',
        'openssl'
    ] %}
{% elif base_package_type == 'deb' %}
    {% set nexus_proxy_packages = [
        'nginx-light',
        'openssl'
    ] %}
{% endif %}

{{ macros.install_packages(nexus_proxy_packages | customizable("packages")) }}

{% block nexus_proxy_setup %}
    # Configure nginx to run as nexus user on non-privileged ports
    RUN if [ -f /etc/nginx/nginx.conf ]; then \
    sed -i 's/^user .*/user nexus;/' /etc/nginx/nginx.conf \
    && sed -i 's/listen.*80;/listen 8080;/' /etc/nginx/nginx.conf \
    && sed -i 's/listen.*443/listen 8443/' /etc/nginx/nginx.conf; \
    fi \
    && mkdir -p /var/log/nginx /var/lib/nginx /var/cache/nginx \
    && chown -R nexus:nexus /var/log/nginx /var/lib/nginx /var/cache/nginx

    # Create proxy-specific directories
    RUN mkdir -p /etc/nexus/proxy /var/log/nexus/proxy \
    && chown -R nexus:nexus /etc/nexus/proxy /var/log/nexus/proxy
{% endblock %}

{% block nexus_proxy_footer %}{% endblock %}
{% block footer %}{% endblock %}

USER nexus