name: Build Kolla OpenStack Images

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      build_target:
        description: 'What to build (e.g. keystone horizon nova)'
        required: false
        default: 'keystone horizon'
        type: string
      base_distro:
        description: 'Base distribution'
        required: false
        default: 'ubuntu'
        type: choice
        options:
          - ubuntu
          - rocky
          - debian
      release:
        description: 'OpenStack release version'
        required: false
        default: '2025.1'
        type: choice
        options:
          - '2024.2'
          - '2025.1'
          - 'master'
      push_images:
        description: 'Push images to registry'
        required: false
        default: true
        type: boolean

env:
  REGISTRY: ghcr.io
  OWNER: fivetime

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Kolla
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install kolla docker

      - name: Simple build
        run: |
          echo "Building: ${{ inputs.build_target || 'keystone horizon' }}"
          echo "Base: ${{ inputs.base_distro || 'ubuntu' }}"
          echo "OpenStack Release: ${{ inputs.release || '2025.1' }}"
          
          kolla-build \
            --base ${{ inputs.base_distro || 'ubuntu' }} \
            --namespace ${{ env.REGISTRY }}/${{ env.OWNER }} \
            --tag ${{ inputs.release || '2025.1' }} \
            --retries 3 \
            ${{ inputs.build_target || 'keystone horizon' }}

      - name: List built images
        if: success()
        run: |
          echo "Built images:"
          docker images | grep "${{ env.REGISTRY }}/${{ env.OWNER }}" || echo "No images found"

      - name: Login to Container Registry
        if: success() && (github.event_name == 'push' || inputs.push_images == true)
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.CR_PAT }}

      - name: Push images
        if: success() && (github.event_name == 'push' || inputs.push_images == true)
        run: |
          echo "Pushing images..."
          
          for image in $(docker images --format "{{.Repository}}:{{.Tag}}" | grep "${{ env.OWNER }}" | grep -v "<none>"); do
            if [[ "$image" == *"${{ env.REGISTRY }}/${{ env.OWNER }}"* ]]; then
              echo "Image already has correct registry prefix: $image"
              echo "Pushing: $image"
              docker push "$image"
            else
              new_tag="${{ env.REGISTRY }}/$image"
              echo "Retagging $image -> $new_tag"
              docker tag "$image" "$new_tag"
              echo "Pushing: $new_tag"
              docker push "$new_tag"
            fi
          done